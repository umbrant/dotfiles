#!/bin/bash

#set -x

function quit {
    mplayer -ao pulse $DIR/sounds/New.wav > /dev/null < /dev/null 2>&1 &
    exit $rc
}

function success {
    mplayer -ao pulse $DIR/sounds/Off.wav > /dev/null < /dev/null 2>&1 &
    exit 0
}

function maven_compile {
    test $# -lt 1 && echo "Runtime error: need argument!" && exit 1
    pushd $1
    mvn $CLEAN package install test -Pdist,native -DskipTests -Dmaven.javadoc.skip || quit
    popd
}

function maven_eclipse {
    test $# -lt 1 && echo "Runtime error: need argument!" && exit 1
    pushd $1
    mvn eclipse:clean || quit
    mvn eclipse:eclipse || quit
    popd
}

name=`basename $0`
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

test $# -lt 1 && echo "Usage `basename $0` hadoop_repo" && exit 1

# Change to the specified directory
pushd $1
shift

# Check if it's a clean build or not
CLEAN=
if [ "$1" == "clean" ]; then
    CLEAN=$1
    echo "Doing a clean build"
fi
shift

if [ "$name" == "bhall" ]; then
    # Do a top-level clean if bhall is specified
    if [ "$CLEAN" == "clean" ]; then
        mvn clean || quit
    fi
    maven_compile hadoop-project
    maven_compile hadoop-assemblies
    maven_compile hadoop-common-project/hadoop-annotations
    maven_compile hadoop-common-project/hadoop-auth
fi

if [ "$name" == "bhall" -o "$name" == "bhc" ]; then
    maven_compile hadoop-common-project/hadoop-common
fi

if [ "$name" == "bhall" -o "$name" == "bhdfs" ]; then
    maven_compile hadoop-hdfs-project/hadoop-hdfs
fi

if [ "$name" == "beclipse" ]; then
    # Trunk now requires the maven plugins to build eclipse:eclipse
    if [ -d "hadoop-maven-plugins" ]; then
        maven_compile hadoop-maven-plugins
    fi

    #maven_eclipse hadoop-assemblies
    maven_eclipse hadoop-common-project/hadoop-annotations
    maven_eclipse hadoop-common-project/hadoop-auth
    maven_eclipse hadoop-common-project/hadoop-common
    maven_eclipse hadoop-hdfs-project/hadoop-hdfs
fi

popd
success
